(function(a){a.fn.gMap=function(b){var c=a.extend({},a.fn.gMap.defaults,b);return this.each(function(){var f=google.maps;var m=a(this);var l=new f.LatLng(c.latitude,c.longitude);var e={zoom:c.zoom,center:l,mapTypeControl:c.mapTypeControl,zoomControl:c.zoomControl,panControl:c.panControl,scaleControl:c.scaleControl,streetViewControl:c.streetViewControl,mapTypeId:c.maptype,scrollwheel:c.scrollwheel};var d=new f.Map(this,e);m.data("$gmap",d);var r=new f.Geocoder();if(c.address){r.geocode({address:c.address},function(i,j){if(j==google.maps.GeocoderStatus.OK){d.setCenter(i[0].geometry.location)}else{if(c.log){console.log("Geocode was not successful for the following reason: "+j)}}});d.setZoom(c.zoom)}else{if(c.latitude&&c.longitude){d.setCenter(new f.LatLng(c.latitude,c.longitude),c.zoom)}else{if(a.isArray(c.markers)&&c.markers.length>0){if(c.markers[0].address){r.geocode({address:c.markers[0].address},function(i,j){if(j==google.maps.GeocoderStatus.OK){d.setCenter(i[0].geometry.location)}else{if(c.log){console.log("Geocode was not successful for the following reason: "+j)}}})}else{d.setCenter(new f.LatLng(c.markers[0].latitude,c.markers[0].longitude));d.setZoom(c.zoom)}}else{d.setCenter(new f.LatLng(c.latitude,c.longitude));d.setZoom(c.zoom)}}}if(c.controls.length!=0){for(var k=0;k<c.controls.length;k++){map.controls[c.controls[k].pos].push(c.controls[k].div)}}for(var g in c.markers){var h=c.markers[g];if(c.log){console.log("putting marker no "+g+" at "+h.latitude+", "+h.longitude+" with address "+h.address+" and html "+h.html)}var q={};q.image=c.icon.image;q.iconSize=(a.isArray(c.icon.iconsize))?new f.Size(c.icon.iconsize[0],c.icon.iconsize[1]):c.icon.iconsize;q.iconAnchor=(a.isArray(c.icon.iconanchor))?new f.Point(c.icon.iconanchor[0],c.icon.iconanchor[1]):c.icon.iconanchor;q.infoWindowAnchor=(a.isArray(c.icon.infowindowanchor))?new f.Size(c.icon.infowindowanchor[0],c.icon.infowindowanchor[1]):c.icon.infowindowanchor;var o={};o.shadow=c.icon.shadow;o.shadowSize=(a.isArray(c.icon.shadowsize))?new f.Size(c.icon.shadowsize[0],c.icon.shadowsize[1]):c.icon.shadowsize;if(h.icon){q.image=h.icon.image;q.iconSize=(a.isArray(h.icon.iconsize))?new f.Size(h.icon.iconsize[0],h.icon.iconsize[1]):h.icon.iconsize;q.iconAnchor=(a.isArray(h.icon.iconanchor))?new f.Point(h.icon.iconanchor[0],h.icon.iconanchor[1]):h.icon.iconanchor;q.infoWindowAnchor=(a.isArray(h.icon.infowindowanchor))?new f.Size(h.icon.infowindowanchor[0],h.icon.infowindowanchor[1]):h.icon.infowindowanchor;o.shadow=h.icon.shadow;o.shadowSize=(a.isArray(h.icon.shadowsize))?new f.Size(h.icon.shadowsize[0],h.icon.shadowsize[1]):h.icon.shadowsize}var n=new f.MarkerImage(q.image,q.iconSize,null,q.iconAnchor);var p=new f.MarkerImage(o.image,o.iconSize,null,q.iconAnchor);if(h.address){if(h.html=="_address"){h.html=h.address}if(c.log){console.log("geocoding marker: "+h.address)}(function(i,s,j){r.geocode({address:i.address},function(u,t){if(t==google.maps.GeocoderStatus.OK){var x=new f.Marker({position:u[0].geometry.location,icon:s,title:i.html,map:d});var w;if(i.html){var v={content:c.html_prepend+i.html+c.html_append,pixelOffset:q.infoWindowAnchor};if(c.log){console.log("setup popup with data")}if(c.log){console.log(v)}w=new f.InfoWindow(v);f.event.addListener(x,"click",function(){if(c.log){console.log("opening popup "+i.html)}w.open(d,x)})}if(i.html&&i.popup){if(c.log){console.log("opening popup "+i.html)}w.open(d,x)}}else{if(c.log){console.log("Geocode was not successful for the following reason: "+t)}}})})(h,n,p)}else{(function(i,v,s){if(i.html=="_latlng"){i.html=i.latitude+", "+i.longitude}var w=new f.LatLng(i.latitude,i.longitude);var u=new f.Marker({position:w,icon:v,title:i.html,map:d});var t;if(i.html){var j={content:c.html_prepend+i.html+c.html_append,pixelOffset:q.infoWindowAnchor};t=new f.InfoWindow(j);f.event.addListener(u,"click",function(){if(c.log){console.log("opening popup "+i.html)}t.open(d,u)})}if(i.html&&i.popup){if(c.log){console.log("opening popup "+i.html)}t.open(d,u)}})(h,n,p)}}})};a.fn.gMap.defaults={log:false,address:"",latitude:0,longitude:0,zoom:10,markers:[],controls:{},scrollwheel:true,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:true,zoomControl:true,panControl:false,scaleControl:false,streetViewControl:true,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",shadow:"http://www.google.com/mapfiles/shadow50.png",iconsize:[20,34],shadowsize:[37,34],iconanchor:[9,34],infowindowanchor:[9,2]}}})(jQuery);